<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Users Table</title>
	<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href=" C://Users/Pc/eclipse-workspace/style.css">
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
</head>
<body>
	

	
	<div class="container mt-5">	

		<div class="row" id="welcome-msg">
			<h1> Welcome User!</h1>
			<button class="btn btn-primary" style="margin-left: 500px;" id="update-user"  data-toggle="modal" data-target="#myModal" onclick="showForm()">
				Update Profile</button>
		</div>

		<div class="row pt-5">
		<table class="table table-striped table-bordered" style="width:100%" id="users-table">
			<thead>
				<tr>
					<th>User Name</th>
					<th>Name</th>
					<th>City</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
	</div>	
	</div>
	<div class="modal fade" id="myModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
		<div class="modal-dialog">
		  <div class="modal-content">
			<div class="modal-header">
			  <h5 class="modal-title" id="exampleModalLabel">Update My Profile</h5>
				<form id="update-form">
					<div class="form-group">
					  <label for="userName">User Name:</label>
					  <input type="text" class="form-control" id="userName">
					</div>
					<div class="form-group">
					  <label for="name">Name:</label>
					  <input type="text" class="form-control" id="name">
					</div>
					<div class="form-group">
					  <label for="city">Name:</label>
					  <input type="text" class="form-control" id="city">
					</div>
				  </form>
			</div>
			
			<div class="modal-footer">
			  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="closeForm(event)">Close</button>
			  <button type="button" class="btn btn-primary"  id="update-user-submit" onclick="updateUser(event)">Save changes</button>
			</div>
		  </div>
		</div>
	  </div>
	
	
	<script>

        const token = localStorage.getItem('jwtToken');
        //const token = "eyJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJudSIsImV4cCI6MTY3ODExMTY2OSwiaWF0IjoxNjc4MTEwMjI5fQ.L8GN1G6wY72xcfdVzllsv4TxwrUHEjyDMz2CLCcz2SY";
        console.log(token);
		const queryString = window.location.search;
		const urlParams = new URLSearchParams(queryString);
		var userNameArg = urlParams.get('id');
		const updateUserBtn = document.getElementById('update-user');
		var fetchedUserData;

		getUserData(userNameArg);

		function getUserData(userNameArg){
			console.log("userNameArg " + userNameArg);
			const userData = {
					userName: userNameArg,
					};
					console.log(userData);
			// Fetch user data from the API
			fetch('http://localhost:8080/user', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${token}`
				},
				body: JSON.stringify(userData)
			})
			.then(response => response.json())
			.then(data => {

				if(data.status==='SUCCESS'){
				// Create a new row for each user and add it to the table
					console.log(data.payload);
					fetchedUserData=data.payload;
					const tableBody = document.querySelector('#users-table tbody');
					const row = document.createElement('tr');
					row.innerHTML = `
							<td>${data.payload.userName}</td>
							<td>${data.payload.name}</td>
							<td>${data.payload.city}</td>
						`;
						tableBody.appendChild(row);

				}
				else{
					alert(data.message);
				}
				
			})
			.catch(error => console.error(error));
		}
		
	
		
		function showForm(){
			var myModal = document.getElementById("myModal");
			myModal.style.display = "block";
			document.getElementById("userName").value = fetchedUserData.userName;
			document.getElementById("name").value = fetchedUserData.name;
			document.getElementById("city").value = fetchedUserData.city;
		}

		function closeForm(){
			event.preventDefault();
			var modal = document.getElementById("myModal");
			modal.style.display = "none";
			location.reload();
		}

		function updateUser(event){
			event.preventDefault();
			// Get the updated profile data from the form
				console.log("updateee");
				const newUserName = document.getElementById("userName").value;
				var newName = document.getElementById("name").value;
				var newCity = document.getElementById("city").value;

				const newUserData = {
					id: fetchedUserData.id,
					userName: newUserName,
					password: fetchedUserData.password,
					name: newName,
					city: newCity,
					roles: fetchedUserData.roles
				}

				console.log("newUserData " + newUserData);

				// Save the updated profile data to the server
				fetch('http://localhost:8080/user/update', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
					'Authorization': `Bearer ${token}`
				},
				body: JSON.stringify(newUserData)
			})
			.then(response => response.json())
			.then(data => {		
				console.log("updated " + data);		
				// Create a new row for each user and add it to the table
				if(data.payload.userName!=fetchedUserData.userName)	{
					window.location.href = 'C:Users/Pc/eclipse-workspace/Login.html';
				}	
				else{
					console.log("newUserName " + data.payload.userName);
					location.reload();
				}
									
			})
			.catch(error => console.error(error));
				// Hide the update form
		}
			
				

	</script>
		
</body>
</html>
